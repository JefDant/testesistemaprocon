<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Dashboard Procon</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
</head>
<body>
<nav class="navbar navbar-light bg-light mb-4">
<div class="container-fluid">
<span class="navbar-brand">Bem‑vindo ao Sistema Procon</span>
<div class="d-flex align-items-center ms-auto">
<span class="me-3 text-secondary small" id="saudacaoUsuario"></span>
<button class="btn btn-outline-danger btn-sm" id="btnLogout">Sair</button>
</div>
</div>
</nav>
<div class="container">
<div class="mb-3 text-center">
<img alt="Logo do Sistema" class="img-fluid" src="logo.png" style="max-height:150px;"/>
</div>
<div class="mb-4 text-end">
<button class="btn btn-success" data-bs-target="#modalNovo" data-bs-toggle="modal">Novo Lançamento</button>
</div>
<table class="table table-striped table-bordered" id="tabela">
<thead>
<tr>
<th>Nome completo</th><th>CPF</th><th>Estado</th><th>Cidade</th>
<th>Associação</th><th>Protocolo</th><th>Registro</th><th>Prazo</th>
<th>Limite</th><th>Descrição</th><th>Status</th><th>Responsável interno</th>
<th>Tipo de solução</th><th>Valor reembolso</th><th>Ações</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<!-- Modal Novo Lançamento -->
<div class="modal fade" id="modalNovo" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<form id="formNovo">
<div class="modal-header">
<h5 class="modal-title">Novo Lançamento</h5>
<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div class="row g-3">
<!-- Campos do formulário -->
<div class="col-md-6"><label class="form-label">Nome completo</label><input class="form-control" name="A" required="" type="text"/></div>
<div class="col-md-6"><label class="form-label">CPF</label><input class="form-control" name="B" required="" type="text"/></div>
<div class="col-md-6"><label class="form-label">Estado</label><select class="form-select" id="estadoSel" name="C" required=""></select></div>
<div class="col-md-6"><label class="form-label">Cidade</label><select class="form-select" disabled="" id="cidadeSel" name="D" required=""></select></div>
<div class="col-md-6"><label class="form-label">Associação</label><select class="form-select" name="E" required=""><option>PREVABRAP</option><option>APDAP PREV</option></select></div>
<div class="col-md-6"><label class="form-label">Nº Protocolo</label><input class="form-control" name="F" required="" type="text"/></div>
<div class="col-md-4"><label class="form-label">Data do registro</label><input class="form-control" id="dataRegistro" name="G" required="" type="date"/></div>
<div class="col-md-4"><label class="form-label">Prazo (dias)</label><input class="form-control" id="prazo" name="H" required="" type="number"/></div>
<div class="col-md-4"><label class="form-label">Data limite</label><input class="form-control" id="dataLimite" name="I" readonly type="date"/></div>
<div class="col-12"><label class="form-label">Descrição</label><textarea class="form-control" name="J" required="" rows="2"></textarea></div>
<div class="col-md-6"><label class="form-label">Status</label><select class="form-select" name="L" required="">
<option>Aberta</option><option>Em análise</option><option>Em negociação</option>
<option>Encaminhada ao fornecedor</option><option>Aguardando resposta do fornecedor</option>
<option>Resolvida</option><option>Arquivada sem solução</option>
</select></div>
<div class="col-md-6"><label class="form-label">Responsável interno</label><input class="form-control" id="respInterno" name="M" readonly required type="text"/></div>
<div class="col-md-6"><label class="form-label">Tipo de solução</label><select class="form-select" name="N" required="">
<option>Reembolso simples</option><option>Reembolso em dobro</option><option>Outro</option>
</select></div>
<div class="col-md-6"><label class="form-label">Valor do reembolso</label><input class="form-control" name="O" required="" step="0.01" type="number"/></div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
<button class="btn btn-primary" type="submit">Salvar</button>
</div>
</form>
</div>
</div>
</div>
<!-- jQuery, Bootstrap, DataTables JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
    const BASE = 'https://script.google.com/macros/s/AKfycbyH71CySyT2bgbE8LU9iFPCu42jgVk-OQg7I9DCL3VYYqc1FmX3l0pGOhxHCAp-qad9/exec';

    // Carrega Estados via IBGE
    async function loadEstados() {
      const res = await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados');
      const estados = await res.json();
      estados.sort((a,b)=>a.nome.localeCompare(b.nome))
              .forEach(e => $('#estadoSel').append(new Option(e.nome, e.sigla)));
    }
    $('#estadoSel').on('change', async function() {
      const uf = this.value;
      const sel = $('#cidadeSel').empty();
      if (!uf) return sel.prop('disabled', true);
      const res = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`);
      (await res.json()).forEach(c=> sel.append(new Option(c.nome, c.nome)));
      sel.prop('disabled', false);
    });

    // Calcula data limite
    function calcLimite() {
      const dr = $('#dataRegistro').val();
      const prazo = parseInt($('#prazo').val())||0;
      if (dr) {
        const d = new Date(dr);
        d.setDate(d.getDate() + prazo);
        $('#dataLimite').val(d.toISOString().slice(0,10));
      }
    }
    $('#prazo').on('input', calcLimite);
    $('#dataRegistro').on('change', calcLimite);

    // Carrega lançamentos na tabela
    let tabela;
    function formatDateISOtoBR(dateString) {
      if (!dateString) return '';
      const d = new Date(dateString);
      if (isNaN(d)) return dateString;
      return d.toLocaleDateString('pt-BR');
    }
      async function loadEntries() {
        const res = await fetch(BASE, {
        method: 'POST',
        body: JSON.stringify({ action: 'entriesList' })
      });
      const data = await res.json();
        const body = $('#tabela tbody').empty();
        data.forEach((row, index) => {
          const tr = $('<tr>');
          Object.entries(row).forEach(([key, value]) => {
            const formatted = (key.toLowerCase().includes('data') || key.toLowerCase().includes('registro') || key.toLowerCase().includes('limite'))
                            ? formatDateISOtoBR(value)
                            : value;
            tr.append($('<td>').text(formatted));
          });

          // Substitui a lista suspensa de status por texto puro
          
const statusOptions = [
  "Aberta", "Em análise", "Em negociação",
  "Encaminhada ao fornecedor", "Aguardando resposta do fornecedor",
  "Resolvida", "Arquivada sem solução", "Cancelado"
];
const select = $('<select class="form-select form-select-sm status-select">').data('protocolo', row.Protocolo);
statusOptions.forEach(opt => {
  select.append(`<option${opt === row.Status ? ' selected' : ''}>${opt}</option>`);
});
tr.children().eq(10).html(select);


          // Adiciona a célula de ações
          const actionsTd = $('<td class="text-center">');
          const dropdown = $(`
            <div class="dropdown">
              <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                ⋯
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item btn-editar" href="#" data-index="${index}">Editar</a></li>
              </ul>
            </div>
          `);
          actionsTd.append(dropdown);
          tr.append(actionsTd);

          body.append(tr);
        });
      
        if (!tabela) tabela = $('#tabela').DataTable();
      }

    // Novo lançamento
    $('#formNovo').on('submit', async function(e) {
      e.preventDefault();
      const obj = { action: 'entries' };
      $(this).serializeArray().forEach(item => obj[item.name] = item.value);
      const res = await fetch(`${BASE}?action=entries`, {
        method: 'POST',
        body: JSON.stringify(obj)
      });
      const d = await res.json();
      if (d.ok) { $('#modalNovo').modal('hide'); loadEntries(); }
      else alert('Erro ao salvar.');
    });
    
    // Inicialização
    
    $(document).on('change', '.status-select', async function() {
      const novoStatus = $(this).val();
      const protocolo = $(this).data('protocolo');
      const responsavel = localStorage.getItem('user') || '';

      const obj = {
        action: 'updateStatus',
        protocolo: protocolo,
        status: novoStatus,
        responsavel: responsavel
      };

      const res = await fetch(BASE, {
        method: 'POST',
        body: JSON.stringify(obj)
      });

      const data = await res.json();
      if (data.ok) {
        alert('Status atualizado com sucesso!');
        loadEntries();
      } else {
        alert('Erro ao atualizar status: ' + (data.msg || ''));
      }
    });

$(document).ready(() => {
  const user = localStorage.getItem('user') || '';
  $('#respInterno').val(user);
  $('#saudacaoUsuario').text('Olá, ' + user);
  $('#btnLogout').on('click', () => {
    localStorage.removeItem('user');
    window.location.href = 'index.html';
  });

      loadEstados();
      loadEntries();
    });
  </script>
</body>
</html>
